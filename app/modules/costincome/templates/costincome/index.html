{% extends "base.html" %}

{% block title %}Gab-Lab Finance - Einnahmen/Ausgaben{% endblock %}

{% block extra_css %}
<style>
    .income {
        color: #198754;
    }
    .outcome {
        color: #dc3545;
    }
    .balance-positive {
        color: #198754;
        font-weight: bold;
    }
    .balance-negative {
        color: #dc3545;
        font-weight: bold;
    }
    .summary-card {
        transition: all 0.3s;
    }
    .summary-card:hover {
        transform: translateY(-5px);
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    .collapsible-card {
        margin-bottom: 1rem;
    }
    .card-header-clickable {
        cursor: pointer;
    }
    .card-header-clickable:hover {
        background-color: #f5f5f5;
    }
    .category-badge {
        font-size: 85%;
        padding: 0.4em 0.6em;
        margin-right: 0.3em;
        display: inline-block;
        margin-bottom: 0.3em;
    }
    .category-income {
        background-color: rgba(25, 135, 84, 0.1);
        color: #198754;
        border: 1px solid #198754;
    }
    .category-outcome {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border: 1px solid #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Einnahmen/Ausgaben Übersicht</h1>
    <a href="{{ url_for('costincome.add') }}" class="btn btn-primary">
        <i class="fas fa-plus me-1"></i> Neuer Eintrag
    </a>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card h-100 summary-card shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title text-muted">Einnahmen ({{ current_month_name }})</h5>
                <p class="display-6 income">{{ "%.2f"|format(income_total) }} €</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100 summary-card shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title text-muted">Ausgaben ({{ current_month_name }})</h5>
                <p class="display-6 outcome">{{ "%.2f"|format(outcome_total) }} €</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100 summary-card shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title text-muted">Bilanz ({{ current_month_name }})</h5>
                <p class="display-6 {% if balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                    {{ "%.2f"|format(balance) }} €
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Chart -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
        <h5 class="mb-0">Monatliche Einnahmen und Ausgaben</h5>
    </div>
    <div class="card-body">
        {% if monthly_stats %}
        <div class="chart-container">
            <canvas id="monthlyChart"></canvas>
        </div>
        {% else %}
        <p class="text-center text-muted my-3">Keine Daten für die Grafik vorhanden</p>
        {% endif %}
    </div>
</div>

<!-- Monthly Statistics -->
<div class="card mb-4 shadow-sm collapsible-card">
    <div class="card-header bg-light card-header-clickable" data-bs-toggle="collapse" data-bs-target="#monthlyStatsCollapse" aria-expanded="true">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Monatliche Übersicht</h5>
            <i class="fas fa-chevron-down"></i>
        </div>
    </div>
    <div class="collapse show" id="monthlyStatsCollapse">
        <div class="card-body">
            {% if monthly_stats %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Monat</th>
                            <th class="text-end">Einnahmen</th>
                            <th class="text-end">Ausgaben</th>
                            <th class="text-end">Bilanz</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in monthly_stats %}
                        <tr>
                            <td>{{ stat.month }}</td>
                            <td class="text-end income">{{ "%.2f"|format(stat.income) }} €</td>
                            <td class="text-end outcome">{{ "%.2f"|format(stat.outcome) }} €</td>
                            <td class="text-end {% if stat.balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                                {{ "%.2f"|format(stat.balance) }} €
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted my-3">Keine Daten vorhanden</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Entries List -->
<div class="card shadow-sm collapsible-card">
    <div class="card-header bg-light card-header-clickable" data-bs-toggle="collapse" data-bs-target="#entriesListCollapse" aria-expanded="false">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Alle Einträge</h5>
            <i class="fas fa-chevron-down"></i>
        </div>
    </div>
    <div class="collapse" id="entriesListCollapse">
        <div class="card-body">
            {% if entries %}
            <!-- Filter controls -->
            <div class="mb-3">
                <div class="input-group">
                    <select class="form-select" id="month-filter">
                        <option value="all">Alle Monate</option>
                        {% for stat in monthly_stats %}
                        <option value="{{ stat.month_key }}">{{ stat.month }}</option>
                        {% endfor %}
                    </select>
                    <select class="form-select" id="type-filter">
                        <option value="all">Alle Typen</option>
                        <option value="income">Nur Einnahmen</option>
                        <option value="outcome">Nur Ausgaben</option>
                    </select>
                    <button class="btn btn-outline-secondary" type="button" id="filter-button">
                        <i class="fas fa-filter me-1"></i> Filtern
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover" id="entries-table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Typ</th>
                            <th>Kategorie</th>
                            <th>Beschreibung</th>
                            <th class="text-end">Betrag</th>
                            <th class="text-end">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in entries %}
                        <tr data-month="{{ entry.date[:7] if entry.date is defined else '' }}" data-type="{{ entry.type }}">
                            <td>{{ entry.date }}</td>
                            <td>
                                {% if entry.type == 'income' %}
                                <span class="badge bg-success">Einnahme</span>
                                {% else %}
                                <span class="badge bg-danger">Ausgabe</span>
                                {% endif %}
                            </td>
                            <td>{{ entry.category }}</td>
                            <td>{{ entry.description }}</td>
                            <td class="text-end {% if entry.type == 'income' %}income{% else %}outcome{% endif %}">
                                {{ "%.2f"|format(entry.amount) }} €
                            </td>
                            <td class="text-end">
                                <form method="POST" action="{{ url_for('costincome.delete', entry_id=entry.id) }}" 
                                      class="d-inline" onsubmit="return confirm('Sind Sie sicher?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted my-3">Keine Einträge vorhanden. Fügen Sie einen neuen Eintrag hinzu!</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Category totals (collapsible) -->
<div class="row mt-4">
    <!-- Income Categories -->
    <div class="col-md-6">
        <div class="card shadow-sm collapsible-card">
            <div class="card-header bg-light card-header-clickable" data-bs-toggle="collapse" data-bs-target="#incomeCategoriesCollapse" aria-expanded="false">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Einnahmen nach Kategorien</h5>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="collapse" id="incomeCategoriesCollapse">
                <div class="card-body">
                    {% if income_by_category %}
                    <div class="chart-container">
                        <canvas id="incomeCategoryChart"></canvas>
                    </div>
                    <div class="mt-3">
                        {% for category, amount in income_by_category.items() %}
                        <span class="badge rounded-pill category-badge category-income">
                            {{ category }}: {{ "%.2f"|format(amount) }} €
                        </span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-center text-muted my-3">Keine Einnahmen Kategorien vorhanden</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Outcome Categories -->
    <div class="col-md-6">
        <div class="card shadow-sm collapsible-card">
            <div class="card-header bg-light card-header-clickable" data-bs-toggle="collapse" data-bs-target="#outcomeCategoriesCollapse" aria-expanded="false">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Ausgaben nach Kategorien</h5>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="collapse" id="outcomeCategoriesCollapse">
                <div class="card-body">
                    {% if outcome_by_category %}
                    <div class="chart-container">
                        <canvas id="outcomeCategoryChart"></canvas>
                    </div>
                    <div class="mt-3">
                        {% for category, amount in outcome_by_category.items() %}
                        <span class="badge rounded-pill category-badge category-outcome">
                            {{ category }}: {{ "%.2f"|format(amount) }} €
                        </span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-center text-muted my-3">Keine Ausgaben Kategorien vorhanden</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle icon rotation for collapsible cards
        document.querySelectorAll('.card-header-clickable').forEach(header => {
            header.addEventListener('click', function() {
                const icon = this.querySelector('.fas');
                if (icon) {
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                }
            });
            
            // Initialize the icon states based on collapse state
            const collapseId = header.getAttribute('data-bs-target');
            const collapseEl = document.querySelector(collapseId);
            if (collapseEl && collapseEl.classList.contains('show')) {
                const icon = header.querySelector('.fas');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
            }
        });
        
        // Filter functionality for entries table
        const filterButton = document.getElementById('filter-button');
        if (filterButton) {
            filterButton.addEventListener('click', function() {
                const monthFilter = document.getElementById('month-filter').value;
                const typeFilter = document.getElementById('type-filter').value;
                
                document.querySelectorAll('#entries-table tbody tr').forEach(row => {
                    const rowMonth = row.getAttribute('data-month');
                    const rowType = row.getAttribute('data-type');
                    
                    let showRow = true;
                    
                    if (monthFilter !== 'all' && rowMonth !== monthFilter) {
                        showRow = false;
                    }
                    
                    if (typeFilter !== 'all' && rowType !== typeFilter) {
                        showRow = false;
                    }
                    
                    row.style.display = showRow ? '' : 'none';
                });
            });
        }
        
        // Debug info to console
        console.log("DOM loaded, checking for chart requirements");
        
        try {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error("Chart.js library not loaded correctly");
                return;
            }
            
            // Only proceed if we have data
            {% if monthly_stats %}
            console.log("Monthly stats available, preparing chart data");
            
            // Get the chart data from monthly_stats directly if monthly_stats_chrono is not available
            const chartLabels = [];
            const chartIncomes = [];
            const chartOutcomes = [];
            const chartBalances = [];
            
            // Use chronological order if available, otherwise use monthly_stats
            {% if monthly_stats_chrono is defined %}
                console.log("Using monthly_stats_chrono for chart data");
                // Use data passed from the backend in chronological order
                {% for stat in monthly_stats_chrono %}
                    chartLabels.push("{{ stat.month }}");
                    chartIncomes.push({{ stat.income|float }});
                    chartOutcomes.push({{ stat.outcome|float }});
                    chartBalances.push({{ stat.balance|float }});
                {% endfor %}
            {% else %}
                console.log("monthly_stats_chrono not available, using sorted monthly_stats");
                // Create a sorted copy of monthly_stats (oldest first)
                const sortedStats = [];
                {% for stat in monthly_stats %}
                    sortedStats.push({
                        month: "{{ stat.month }}",
                        monthKey: "{{ stat.month_key if stat.month_key is defined else '' }}",
                        income: {{ stat.income|float }},
                        outcome: {{ stat.outcome|float }},
                        balance: {{ stat.balance|float }}
                    });
                {% endfor %}
                
                // Sort by month_key if available, otherwise by month string
                sortedStats.sort(function(a, b) {
                    if (a.monthKey && b.monthKey) {
                        return a.monthKey.localeCompare(b.monthKey);
                    }
                    return a.month.localeCompare(b.month);
                });
                
                // Add sorted data to chart arrays
                for (const stat of sortedStats) {
                    chartLabels.push(stat.month);
                    chartIncomes.push(stat.income);
                    chartOutcomes.push(stat.outcome);
                    chartBalances.push(stat.balance);
                }
            {% endif %}
            
            console.log("Chart data prepared:", {
                labels: chartLabels,
                incomes: chartIncomes,
                outcomes: chartOutcomes,
                balances: chartBalances
            });
            
            // Make sure the canvas exists
            const chartCanvas = document.getElementById('monthlyChart');
            if (!chartCanvas) {
                console.error("Chart canvas element 'monthlyChart' not found in the DOM");
                return;
            }
            
            console.log("Creating chart with Canvas context");
            const ctx = chartCanvas.getContext('2d');
            const monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'Einnahmen',
                            data: chartIncomes,
                            backgroundColor: 'rgba(25, 135, 84, 0.7)',
                            borderColor: 'rgba(25, 135, 84, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Ausgaben',
                            data: chartOutcomes,
                            backgroundColor: 'rgba(220, 53, 69, 0.7)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Bilanz',
                            data: chartBalances,
                            type: 'line',
                            borderColor: 'rgba(13, 110, 253, 1)',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointBackgroundColor: 'rgba(13, 110, 253, 1)',
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' €';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('de-DE', { 
                                            style: 'currency', 
                                            currency: 'EUR' 
                                        }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            console.log("Monthly chart created successfully");
            {% else %}
            console.log("No monthly_stats data available for chart");
            {% endif %}
            
            // Create category charts if data is available
            {% if income_by_category %}
            const incomeCategoryCanvas = document.getElementById('incomeCategoryChart');
            if (incomeCategoryCanvas) {
                // Consolidate categories with the same name
                const consolidatedCategories = {};
                
                {% for category, amount in income_by_category.items() %}
                // If category already exists, add to its amount, otherwise create new entry
                if (consolidatedCategories["{{ category }}"]) {
                    consolidatedCategories["{{ category }}"] += {{ amount|float }};
                } else {
                    consolidatedCategories["{{ category }}"] = {{ amount|float }};
                }
                {% endfor %}
                
                // Now create arrays from the consolidated data
                const categoryLabels = Object.keys(consolidatedCategories);
                const categoryValues = Object.values(consolidatedCategories);
                
                new Chart(incomeCategoryCanvas.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryValues,
                            backgroundColor: [
                                'rgba(25, 135, 84, 0.8)',
                                'rgba(32, 156, 105, 0.8)',
                                'rgba(40, 178, 125, 0.8)',
                                'rgba(47, 199, 146, 0.8)',
                                'rgba(55, 221, 166, 0.8)',
                                'rgba(62, 242, 187, 0.8)',
                                'rgba(104, 244, 198, 0.8)',
                                'rgba(145, 247, 208, 0.8)'
                            ],
                            borderColor: 'rgba(255, 255, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.formattedValue;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((context.raw / total) * 100);
                                        return `${label}: ${value} € (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                console.log("Income category chart created successfully");
            }
            {% endif %}
            
            {% if outcome_by_category %}
            const outcomeCategoryCanvas = document.getElementById('outcomeCategoryChart');
            if (outcomeCategoryCanvas) {
                // Consolidate categories with the same name
                const consolidatedCategories = {};
                
                {% for category, amount in outcome_by_category.items() %}
                // If category already exists, add to its amount, otherwise create new entry
                if (consolidatedCategories["{{ category }}"]) {
                    consolidatedCategories["{{ category }}"] += {{ amount|float }};
                } else {
                    consolidatedCategories["{{ category }}"] = {{ amount|float }};
                }
                {% endfor %}
                
                // Now create arrays from the consolidated data
                const categoryLabels = Object.keys(consolidatedCategories);
                const categoryValues = Object.values(consolidatedCategories);
                
                new Chart(outcomeCategoryCanvas.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryValues,
                            backgroundColor: [
                                'rgba(220, 53, 69, 0.8)',
                                'rgba(235, 78, 93, 0.8)',
                                'rgba(239, 103, 116, 0.8)',
                                'rgba(242, 128, 139, 0.8)',
                                'rgba(246, 153, 162, 0.8)',
                                'rgba(249, 178, 185, 0.8)',
                                'rgba(252, 203, 207, 0.8)',
                                'rgba(255, 228, 230, 0.8)'
                            ],
                            borderColor: 'rgba(255, 255, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.formattedValue;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((context.raw / total) * 100);
                                        return `${label}: ${value} € (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                console.log("Outcome category chart created successfully");
            }
            {% endif %}
            
        } catch (error) {
            console.error("Error creating chart:", error);
        }
    });
</script>
{% endblock %}